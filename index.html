<script>
    let contractsData = [];
    let filteredData = [];
    let charts = {};
    
    // تعريف جميع أسماء الأعمدة الجديدة والمقابلة لها في ملف CSV
    const COLUMN_MAPPINGS = {
        Contract_ID: ['عقد رقم', 'رقم العقد'],
        Report_Date: ['تاريخ التقرير'],
        Contractor: ['المقاول', 'contractor', 'vendor'],
        Consultant: ['الإستشاري'],
        Supervisor_Engineer: ['المهندس المشرف', 'المشرف', 'engineer', 'supervisor'],
        Project_Name: ['المشروع', 'اسم المشروع'],
        Category: ['التصنيف (انارة - طرق )', 'تصنيف المشروع'],
        Axis: ['المحور'],
        // KPIs الرئيسية
        Target_Completion_Rate: ['نسبة الانجاز المستهدفه'],
        Actual_Completion_Rate: ['نسبة الانجاز الفعلية'],
        Elapsed_Time_Rate: ['نسبة المدة المنقضية'],
        Actual_Deviation_Rate: ['نسبة الإنحراف الفعلية'], // هذا أصبح موجوداً في المصدر
        Target_Weighted_Index: ['مؤشر أداء المقاول حسب الاوزان المستهدف'],
        Actual_Weighted_Index: ['مؤشر أداء المقاول حسب الاوزان الفعلى'],
        // المؤشرات المالية
        Total_Contract_Value: ['قيمة العقد (ريال)'],
        Actual_Financial_Value: ['المنفذ فعلياً (نسبة الإنجاز)'],
        Target_Financial_Value: ['القيمة المخطط لها'],
        Delayed_Financial_Value: ['الإنحراف عن التكلفة (CV)'],
        // مؤشرات أخرى لم تُستخدم في الـ KPI العام لكن يجب حفظها
        Project_Status: ['حاله المشروع'],
        General_Rating: ['التقييم العام للمقاول'],
        // مؤشرات التفاصيل (للتجميع والتحليل المستقبلي)
        // سيتم معالجتها كأعمدة إضافية لكن لن تؤثر على الـ KPI الرئيسي الحالي
        // ... (يمكن إضافة جميع الأعمدة الطويلة هنا إذا لزم الأمر)
    };
    

    // File handling
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    function handleFile(file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                processContractsData(rawData);
                showDashboard();
                
            } catch (error) {
                alert('خطأ في قراءة الملف: ' + error.message);
            }
        };
        
        reader.readAsArrayBuffer(file);
    }

    function findColumnIndex(headers, searchTerms) {
        return headers.findIndex(header => {
            if (!header) return false;
            const headerStr = header.toString().toLowerCase().trim();
            // Match the terms exactly or partially (more flexible)
            return searchTerms.some(term => headerStr.includes(term.toLowerCase()));
        });
    }

    function getNumericValue(row, index) {
        const raw = row[index];
        if (typeof raw === 'number') return raw;
        if (typeof raw === 'string') {
            // Remove non-numeric characters except dot and return as float
            const cleaned = raw.replace(/[^\d.-]/g, '');
            return parseFloat(cleaned) || 0;
        }
        return 0;
    }

    function processContractsData(rawData) {
        if (rawData.length === 0) return;
        
        const headers = rawData[0].map(h => h ? h.toString().trim() : '');
        const dataRows = rawData.slice(1).filter(row => row.some(cell => cell !== null && cell !== undefined && cell !== ''));
        
        // Map headers to column indices
        const indices = {};
        Object.keys(COLUMN_MAPPINGS).forEach(key => {
            indices[key] = findColumnIndex(headers, COLUMN_MAPPINGS[key]);
        });
        
        contractsData = [];
        const engineers = new Set();
        const categories = new Set();
        const axes = new Set();

        dataRows.forEach((row, index) => {
            
            // Extract core KPI fields
            const actualWeightedIndex = getNumericValue(row, indices.Actual_Weighted_Index);
            const timeElapsedRate = getNumericValue(row, indices.Elapsed_Time_Rate);
            const actualCompletionRate = getNumericValue(row, indices.Actual_Completion_Rate);
            const targetFinancialValue = getNumericValue(row, indices.Target_Financial_Value);
            const actualFinancialValue = getNumericValue(row, indices.Actual_Financial_Value);

            // Calculate Deviation based on Actual_Weighted_Index (new primary KPI)
            // If the deviation column exists and is numeric, use it. Otherwise, calculate based on the new KPI vs Time.
            let deviation;
            if (indices.Actual_Deviation_Rate !== -1 && getNumericValue(row, indices.Actual_Deviation_Rate) !== 0) {
                 deviation = getNumericValue(row, indices.Actual_Deviation_Rate);
            } else {
                 // Use the new main KPI for deviation calculation
                 // We will compare the weighted index against the expected progress (Elapsed Time Rate)
                 deviation = actualWeightedIndex - timeElapsedRate;
            }
            
            const contract = {
                id: index + 1,
                // Identification Fields
                contractNumber: row[indices.Contract_ID] || `عقد-${index + 1}`,
                projectName: row[indices.Project_Name] || `مشروع ${index + 1}`,
                contractor: row[indices.Contractor] || 'غير محدد',
                engineer: row[indices.Supervisor_Engineer] || 'غير محدد',
                category: row[indices.Category] || 'غير محدد',
                axis: row[indices.Axis] || 'غير محدد',
                
                // Performance Metrics (New Logic)
                completion: actualCompletionRate, // Still useful
                weightedIndex: actualWeightedIndex, // New Main KPI (The true performance)
                timeElapsed: timeElapsedRate,
                deviation: deviation,
                
                // Financial Metrics
                financialTarget: targetFinancialValue,
                financialActual: actualFinancialValue,
                financialDeviation: actualFinancialValue - targetFinancialValue,
                
                // Status Calculation (Based on Weighted Index vs Time Elapsed Rate)
                status: getProjectStatus(actualWeightedIndex, timeElapsedRate)
            };

            contractsData.push(contract);
            
            if (contract.engineer !== 'غير محدد') engineers.add(contract.engineer);
            if (contract.category !== 'غير محدد') categories.add(contract.category);
            if (contract.axis !== 'غير محدد') axes.add(contract.axis);
        });

        // Populate filter dropdowns
        populateFilterDropdown('engineerFilter', Array.from(engineers));
        // Use Category for the Contract Type filter (as it represents the nature of work)
        populateFilterDropdown('contractTypeFilter', Array.from(categories));

        filteredData = [...contractsData];
        updateDashboard();
        document.getElementById('lastUpdate').textContent = `آخر تحديث: ${new Date().toLocaleDateString('ar-SA')}`;
    }

    function getProjectStatus(actualIndex, timeElapsed) {
        const difference = actualIndex - timeElapsed;
        if (difference > 5) return 'متقدم';
        if (difference >= -5) return 'في الموعد';
        return 'متأخر';
    }

    function populateFilterDropdown(elementId, options) {
        const select = document.getElementById(elementId);
        // Clear previous options except the default one
        select.innerHTML = '<option value="">جميع المهندسين</option>';
        if (elementId === 'contractTypeFilter') {
            select.innerHTML = '<option value="">جميع الأنواع</option>';
        }

        options.sort().forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            select.appendChild(optionElement);
        });
    }

    function showDashboard() {
        document.getElementById('uploadSection').classList.add('hidden');
        document.getElementById('dashboardContent').classList.remove('hidden');
    }

    function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabName + 'Content').classList.remove('hidden');
        document.getElementById(tabName + 'Tab').classList.add('active');
        
        // Update charts if needed
        setTimeout(() => {
            if (tabName === 'category') {
                updateCategoryCharts();
            } else if (tabName === 'vendor') {
                updateVendorCharts();
            }
        }, 100);
    }

    function applyFilters() {
        const dateFilter = document.getElementById('dateFilter').value; // Not used in filtering as Report_Date is complex
        const engineerFilter = document.getElementById('engineerFilter').value;
        const contractTypeFilter = document.getElementById('contractTypeFilter').value;

        filteredData = contractsData.filter(contract => {
            let matches = true;
            
            if (engineerFilter && contract.engineer !== engineerFilter) {
                matches = false;
            }
            
            // Filtering by Category (using the new 'category' field)
            if (contractTypeFilter && contract.category !== contractTypeFilter) {
                matches = false;
            }
            
            return matches;
        });

        updateDashboard();
    }

    function updateDashboard() {
        if (filteredData.length === 0) {
            // Handle empty data case
            document.getElementById('completionRate').textContent = '0%';
            document.getElementById('timeElapsed').textContent = '0%';
            document.getElementById('deviationRate').textContent = '0%';
            document.getElementById('deviationStatus').textContent = 'لا توجد بيانات';
            document.getElementById('targetFinancial').textContent = '0 ر.س';
            document.getElementById('actualFinancial').textContent = '0 ر.س';
            document.getElementById('financialDeviation').textContent = '0 ر.س';
            document.getElementById('contractsTableBody').innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">لا توجد عقود مطابقة للفلاتر</td></tr>';
            
            // Destroy existing charts to prevent errors
            Object.keys(charts).forEach(key => {
                if (charts[key]) {
                    charts[key].destroy();
                    charts[key] = null;
                }
            });
            return;
        }

        // 1. Calculate Summary KPIs (using Weighted Index as the primary performance metric)
        const totalContracts = filteredData.length;
        const totalWeightedIndex = filteredData.reduce((sum, c) => sum + c.weightedIndex, 0);
        const totalTimeElapsed = filteredData.reduce((sum, c) => sum + c.timeElapsed, 0);
        const totalFinancialTarget = filteredData.reduce((sum, c) => sum + c.financialTarget, 0);
        const totalFinancialActual = filteredData.reduce((sum, c) => sum + c.financialActual, 0);

        const avgWeightedIndex = totalWeightedIndex / totalContracts;
        const avgTimeElapsed = totalTimeElapsed / totalContracts;
        const avgDeviation = avgWeightedIndex - avgTimeElapsed; // Deviation based on Weighted Index
        const financialDeviation = totalFinancialActual - totalFinancialTarget;

        // 2. Update KPI Cards (Summary Tab)
        // Completion Rate is replaced by the Weighted Index for overall health
        document.getElementById('completionRate').textContent = `${avgWeightedIndex.toFixed(1)}%`;
        // Change the title to reflect the new KPI
        document.querySelector('.metric-card:first-child h3').textContent = 'مؤشر الأداء الموزون الإجمالي';
        
        document.getElementById('timeElapsed').textContent = `${avgTimeElapsed.toFixed(1)}%`;
        document.getElementById('deviationRate').textContent = `${avgDeviation.toFixed(1)}%`;
        
        document.getElementById('targetFinancial').textContent = `${formatCurrency(totalFinancialTarget)}`;
        document.getElementById('actualFinancial').textContent = `${formatCurrency(totalFinancialActual)}`;
        document.getElementById('financialDeviation').textContent = `${formatCurrency(financialDeviation)}`;
        
        updateDeviationStatus(avgDeviation);
        updateGauge('completionGauge', avgWeightedIndex, '#10b981'); // Green
        updateGauge('timeGauge', avgTimeElapsed, '#3b82f6'); // Blue

        // 3. Update Performance Comparison Chart (Summary Tab)
        updatePerformanceComparisonChart(filteredData);
        
        // 4. Update Detailed Tables and Vendor/Category Tabs if currently active
        renderContractsTable(filteredData);
        
        // Re-run the active tab's update function in case it's visible
        const activeTabId = document.querySelector('.nav-tab.active').id;
        if (activeTabId === 'categoryTab') {
            updateCategoryCharts();
        } else if (activeTabId === 'vendorTab') {
            updateVendorCharts();
        }
    }
    
    // --- Helper Functions ---

    function formatCurrency(number) {
        return number.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR', minimumFractionDigits: 0 });
    }

    function updateDeviationStatus(deviation) {
        const statusEl = document.getElementById('deviationStatus');
        let statusText, statusClass;

        if (deviation >= 5) {
            statusText = 'متقدم (ممتاز)';
            statusClass = 'status-excellent';
        } else if (deviation >= -5) {
            statusText = 'في الموعد (جيد)';
            statusClass = 'status-good';
        } else if (deviation >= -15) {
            statusText = 'متأخر (تنبيه)';
            statusClass = 'status-warning';
        } else {
            statusText = 'متأخر جداً (خطر)';
            statusClass = 'status-danger';
        }

        statusEl.textContent = statusText;
        // Reset classes and apply the new one
        statusEl.className = 'px-3 py-1 rounded-full text-xs font-medium ' + statusClass;
        
        // Update financial deviation color
        const financialEl = document.getElementById('financialDeviation');
        financialEl.classList.remove('text-green-600', 'text-red-600', 'text-gray-800');
        if (deviation > 0) {
            financialEl.classList.add('text-green-600');
        } else if (deviation < 0) {
            financialEl.classList.add('text-red-600');
        } else {
            financialEl.classList.add('text-gray-800');
        }
    }

    // Function to calculate and update the Gauge path
    function updateGauge(elementId, value, color) {
        const gaugeEl = document.getElementById(elementId);
        if (!gaugeEl) return;

        const totalLength = 220; 
        // Ensure value is between 0 and 100
        const safeValue = Math.min(100, Math.max(0, value));
        const offset = totalLength * (1 - (safeValue / 100));
        
        gaugeEl.style.strokeDasharray = `${totalLength} ${totalLength}`;
        gaugeEl.style.strokeDashoffset = offset;
        gaugeEl.style.stroke = color;
    }


    // --- Chart.js Updates ---

    function updatePerformanceComparisonChart(data) {
        // Use the new Weighted Index for the comparison chart
        const avgWeightedIndex = data.reduce((sum, c) => sum + c.weightedIndex, 0) / data.length;
        const avgTimeElapsed = data.reduce((sum, c) => sum + c.timeElapsed, 0) / data.length;

        const ctx = document.getElementById('performanceChart').getContext('2d');
        if (charts.performanceChart) charts.performanceChart.destroy();

        charts.performanceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['الأداء المجمع'],
                datasets: [
                    {
                        label: 'مؤشر الأداء الموزون الفعلي',
                        data: [avgWeightedIndex],
                        backgroundColor: 'rgba(16, 185, 129, 0.8)', // Green
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'نسبة المدة المنقضية (المستهدف)',
                        data: [avgTimeElapsed],
                        backgroundColor: 'rgba(59, 130, 246, 0.8)', // Blue
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: {
                        position: 'top',
                        rtl: true,
                        labels: { usePointStyle: true, font: { family: 'Segoe UI' } }
                    },
                    tooltip: {
                        rtl: true,
                        callbacks: {
                            label: (context) => {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.x !== null) {
                                    label += context.parsed.x.toFixed(1) + '%';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        min: 0,
                        max: 100,
                        title: {
                            display: true,
                            text: 'النسبة المئوية (%)',
                            font: { family: 'Segoe UI' }
                        },
                        ticks: { font: { family: 'Segoe UI' } }
                    },
                    y: {
                        ticks: { font: { family: 'Segoe UI' } }
                    }
                }
            }
        });
    }

    function updateCategoryCharts() {
        // Use 'category' and 'axis' for grouping
        const categorySummary = summarizeData(filteredData, 'category');
        const axisSummary = summarizeData(filteredData, 'axis'); // New grouping by Axis
        
        renderSummaryTable(categorySummary, axisSummary);

        // 1. Category Chart (Doughnut)
        const workTypeCtx = document.getElementById('workTypeChart').getContext('2d');
        if (charts.workTypeChart) charts.workTypeChart.destroy();
        charts.workTypeChart = new Chart(workTypeCtx, getPieChartConfig(
            Object.keys(categorySummary),
            Object.values(categorySummary).map(s => s.avgWeightedIndex), // Use Weighted Index
            'الأداء حسب تصنيف المشروع (Weighted Index)',
            ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
        ));

        // 2. Axis Chart (Contract Type Chart is repurposed)
        const contractTypeCtx = document.getElementById('contractTypeChart').getContext('2d');
        if (charts.contractTypeChart) charts.contractTypeChart.destroy();
        charts.contractTypeChart = new Chart(contractTypeCtx, getPieChartConfig(
            Object.keys(axisSummary),
            Object.values(axisSummary).map(s => s.avgWeightedIndex), // Use Weighted Index
            'الأداء حسب المحور/المنطقة (Weighted Index)',
            ['#ef4444', '#8b5cf6', '#3b82f6', '#10b981', '#f59e0b']
        ));
        
        // Update labels for the Category tab to reflect the change
        document.querySelector('#categoryContent > .grid > div:first-child h3').textContent = 'الأداء حسب تصنيف المشروع';
        document.querySelector('#categoryContent > .grid > div:last-child h3').textContent = 'الأداء حسب المحور/المنطقة';
    }

    function updateVendorCharts() {
        const vendorSummary = summarizeData(filteredData, 'contractor');
        // Sort by deviation (Weighted Index - Time Elapsed)
        const vendorKeys = Object.keys(vendorSummary).sort((a, b) => vendorSummary[b].avgDeviation - vendorSummary[a].avgDeviation);
        const top5Vendors = vendorKeys.slice(0, 5);
        const bottom5Vendors = vendorKeys.slice(-5).reverse();
        const chartVendors = [...top5Vendors, ...bottom5Vendors];

        // 1. Update Vendor Status Cards
        const statuses = filteredData.reduce((acc, c) => {
            acc[c.status] = (acc[c.status] || 0) + 1;
            return acc;
        }, {});
        document.getElementById('advancedVendors').textContent = statuses['متقدم'] || 0;
        document.getElementById('onTimeVendors').textContent = statuses['في الموعد'] || 0;
        document.getElementById('delayedVendors').textContent = statuses['متأخر'] || 0;

        // 2. Vendor Performance Chart (Bar)
        const vendorCtx = document.getElementById('vendorChart').getContext('2d');
        if (charts.vendorChart) charts.vendorChart.destroy();
        
        charts.vendorChart = new Chart(vendorCtx, {
            type: 'bar',
            data: {
                labels: chartVendors,
                datasets: [
                    {
                        label: 'معدل الانحراف عن المسار (KPI الموزون) (%)',
                        data: chartVendors.map(v => vendorSummary[v].avgDeviation),
                        backgroundColor: chartVendors.map(v => vendorSummary[v].avgDeviation > 0 ? '#10b981' : '#ef4444'), // Green or Red
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { rtl: true }
                },
                scales: {
                    x: { ticks: { font: { family: 'Segoe UI' } } },
                    y: {
                        title: { display: true, text: 'معدل الانحراف (%)', font: { family: 'Segoe UI' } },
                        ticks: { font: { family: 'Segoe UI' } }
                    }
                }
            }
        });
        
        renderContractsTable(filteredData);
    }
    
    // Updated to use weightedIndex
    function summarizeData(data, key) {
        const summary = {};
        data.forEach(contract => {
            const group = contract[key];
            if (!summary[group]) {
                summary[group] = {
                    count: 0,
                    totalCompletion: 0,
                    totalWeightedIndex: 0,
                    totalTimeElapsed: 0,
                    totalFinancial: 0
                };
            }
            summary[group].count += 1;
            summary[group].totalCompletion += contract.completion;
            summary[group].totalWeightedIndex += contract.weightedIndex;
            summary[group].totalTimeElapsed += contract.timeElapsed;
            summary[group].totalFinancial += contract.financialActual;
        });

        // Calculate averages and deviation
        Object.keys(summary).forEach(group => {
            const s = summary[group];
            s.avgCompletion = s.totalCompletion / s.count;
            s.avgWeightedIndex = s.totalWeightedIndex / s.count;
            s.avgTimeElapsed = s.totalTimeElapsed / s.count;
            s.avgDeviation = s.avgWeightedIndex - s.avgTimeElapsed;
            s.avgFinancial = s.totalFinancial / s.count;
        });
        return summary;
    }

    function getPieChartConfig(labels, data, title, colors) {
        return {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors.slice(0, labels.length),
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'left',
                        rtl: true,
                        labels: { usePointStyle: true, font: { family: 'Segoe UI' } }
                    },
                    title: {
                        display: true,
                        text: title,
                        font: { family: 'Segoe UI', size: 16 }
                    },
                    tooltip: {
                        rtl: true,
                        callbacks: {
                            label: (context) => {
                                const label = context.label || '';
                                const value = context.parsed;
                                return `${label}: ${value.toFixed(1)}%`;
                            }
                        }
                    }
                }
            }
        };
    }
    
    // --- Table Renderers ---
    
    function renderContractsTable(data) {
        const tableBody = document.getElementById('contractsTableBody');
        const statusFilter = document.getElementById('statusFilter').value;
        
        const filteredTableData = data.filter(c => !statusFilter || c.status === statusFilter);

        if (filteredTableData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">لا توجد عقود مطابقة للحالة المختارة</td></tr>';
            return;
        }

        tableBody.innerHTML = filteredTableData.map(c => {
            let statusClass;
            if (c.status === 'متقدم') statusClass = 'status-excellent';
            else if (c.status === 'في الموعد') statusClass = 'status-good';
            else statusClass = 'status-danger';

            return `
                <tr class="border-b border-gray-100 hover:bg-gray-50 slide-in">
                    <td class="py-3 px-4 text-right text-gray-700 font-medium">${c.contractNumber}</td>
                    <td class="py-3 px-4 text-right text-gray-700">${c.projectName}</td>
                    <td class="py-3 px-4 text-right text-gray-700">${c.contractor}</td>
                    <td class="py-3 px-4 text-right font-medium">${c.weightedIndex.toFixed(1)}%</td>
                    <td class="py-3 px-4 text-right font-medium">${c.timeElapsed.toFixed(1)}%</td>
                    <td class="py-3 px-4 text-right font-medium ${c.deviation > 0 ? 'text-green-600' : 'text-red-600'}">${c.deviation.toFixed(1)}%</td>
                    <td class="py-3 px-4 text-right text-gray-700">${c.engineer}</td>
                    <td class="py-3 px-4 text-center">
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">${c.status}</span>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function renderSummaryTable(categorySummary, axisSummary) {
        const tableBody = document.getElementById('categoryTableBody');
        tableBody.innerHTML = '';
        
        const combinedData = [];
        
        // Add Category summaries (renamed from workType)
        Object.keys(categorySummary).forEach(key => {
            const s = categorySummary[key];
            combinedData.push({
                name: `التصنيف: ${key}`,
                count: s.count,
                // Use weighted index as primary completion metric
                completion: s.avgWeightedIndex, 
                timeElapsed: s.avgTimeElapsed,
                deviation: s.avgDeviation,
                financial: s.avgFinancial
            });
        });

        // Add Axis summaries (renamed from contractType)
        Object.keys(axisSummary).forEach(key => {
            const s = axisSummary[key];
            combinedData.push({
                name: `المحور: ${key}`,
                count: s.count,
                completion: s.avgWeightedIndex, 
                timeElapsed: s.avgTimeElapsed,
                deviation: s.avgDeviation,
                financial: s.avgFinancial
            });
        });
        
        if (combinedData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">لا توجد بيانات للتصنيف</td></tr>';
            return;
        }

        tableBody.innerHTML = combinedData.map(d => {
            const deviationClass = d.deviation > 0 ? 'text-green-600' : d.deviation < 0 ? 'text-red-600' : 'text-gray-700';
            return `
                <tr class="border-b border-gray-100 hover:bg-gray-50 slide-in">
                    <td class="py-3 px-4 text-right text-gray-700 font-medium">${d.name}</td>
                    <td class="py-3 px-4 text-right text-gray-700">${d.count}</td>
                    <td class="py-3 px-4 text-right font-medium">${d.completion.toFixed(1)}%</td>
                    <td class="py-3 px-4 text-right font-medium">${d.timeElapsed.toFixed(1)}%</td>
                    <td class="py-3 px-4 text-right font-medium ${deviationClass}">${d.deviation.toFixed(1)}%</td>
                    <td class="py-3 px-4 text-right font-medium">${formatCurrency(d.financial)}</td>
                </tr>
            `;
        }).join('');
    }

    // --- Export Functions ---
    
    function exportContractsData() {
        const dataToExport = filteredData.map(c => ({
            'رقم العقد': c.contractNumber,
            'اسم المشروع': c.projectName,
            'المقاول': c.contractor,
            'مؤشر الأداء الموزون': c.weightedIndex + '%',
            'نسبة المدة المنقضية': c.timeElapsed + '%',
            'معدل الانحراف': c.deviation + '%',
            'المهندس المشرف': c.engineer,
            'الحالة': c.status
        }));

        const worksheet = XLSX.utils.json_to_sheet(dataToExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'تفاصيل العقود');
        XLSX.writeFile(workbook, 'تفاصيل_عقود_الأداء_الموزون.xlsx');
    }
    
    function exportToGoogleSheets() {
        alert('ميزة "تصدير إلى Google Sheets" تتطلب واجهة برمجية (API) خلفية. يمكنك تصدير ملف إكسل باستخدام زر "تصدير البيانات" في الأسفل، ثم رفعه يدوياً إلى Google Sheets.');
    }
    
    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        // Add event listeners to redraw table/charts when filters change
        document.getElementById('statusFilter').addEventListener('change', () => renderContractsTable(filteredData));
    });
    
    // Initial call to show the first tab
    switchTab('summary');
</script>
